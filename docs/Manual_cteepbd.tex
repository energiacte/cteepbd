\documentclass[10pt,notitlepage,oneside,a4paper]{article}
\usepackage[spanish]{babel}
%\usepackage{iftex}
%\ifPDFTeX
    \usepackage[utf8]{inputenc}
    \usepackage[T1]{fontenc}
    \usepackage{lmodern}
%\else
%   \ifXeTeX
%     \usepackage{fontspec}
%   \else 
%     \usepackage{luatextra}
%   \fi
%   \defaultfontfeatures{Ligatures=TeX}
%\fi
\usepackage{datetime} % Personalizar \today
\usepackage{graphicx}
\usepackage[x11names,rgb]{xcolor}
\usepackage{parskip} 
\usepackage{array}
\usepackage{bm} % bold math symbols
\usepackage[a4paper,includeheadfoot,top=1cm,bottom=1cm,left=2cm,right=2cm,head=1.5cm,text=25cm]{geometry} %márgenes
\usepackage{fancyhdr}
\usepackage{fancyvrb}
\usepackage{listings}
\usepackage{pstricks}
\usepackage{grffile} % nombres de archivo con espacios o guiones bajos
\usepackage[most]{tcolorbox} % cajas con color de fondo
%\usepackage{titlesec}
\usepackage{titletoc}
\usepackage{totpages}
\usepackage{tocloft} % Cambiar aspecto de la tabla de contenidos
\usepackage{siunitx}
\usepackage{booktabs} % Tablas con mejor aspecto
\usepackage{longtable} % tablas que ocupan más de una hoja
\usepackage{enumerate} % http://ctan.org/pkg/enumerate para enumerar con romanos minúsculas
\usepackage{multirow} % http://ctan.org/pkg/multirow
\usepackage{multicol}
\usepackage[hypcap,font=small,labelfont=bf]{caption} % captionof, con hycap usa la parte superior como referencia
\usepackage{capt-of} % Para usar caption fuera de table o figure (flotados)
\usepackage{float} % posicionamiento H para evitar flotar tablas y figuras
\usepackage[draft,inline,nomargin,lang=spanish,author=]{fixme} % notas
\fxsetup{theme=color}
\usepackage[backref,pdfencoding=auto,colorlinks=true,linkcolor=blue]{hyperref}
\usepackage{bookmark} % corrige errores con appendix e hyperref
\usepackage{nameref}% Only if hyperref isn't loaded
% \usepackage{hyperref}

\graphicspath{{./img/}{./imagenes/}}
\renewcommand{\familydefault}{phv} %phv - Helvética para fuente por defecto
\renewcommand{\headrulewidth}{0pt} % Sin línea superior en encabezado
\addto\captionsspanish{\def\tablename{Tabla}} %% Para renombrar cuadros a tablas

\definecolor{block-gray}{gray}{0.95}
\newtcolorbox{myquote}{colback=block-gray,grow to right by=-10mm,grow to left by=-10mm,
boxrule=0pt,boxsep=0pt,breakable}

% Indentados de ToC
\cftsetindents{section}{0em}{5.5em}
\cftsetindents{subsection}{2em}{3.5em}

\setcounter{secnumdepth}{3} %% Hasta que nivel se numeran las secciones
\setcounter{tocdepth}{3} %% Cuantos niveles aparecen en el indice

%% Equivalencias para usar unicode en listings
\lstset{literate=
  {á}{{\'a}}1 {é}{{\'e}}1 {í}{{\'i}}1 {ó}{{\'o}}1 {ú}{{\'u}}1
  {Á}{{\'A}}1 {É}{{\'E}}1 {Í}{{\'I}}1 {Ó}{{\'O}}1 {Ú}{{\'U}}1
  {à}{{\`a}}1 {è}{{\`e}}1 {ì}{{\`i}}1 {ò}{{\`o}}1 {ù}{{\`u}}1
  {À}{{\`A}}1 {È}{{\'E}}1 {Ì}{{\`I}}1 {Ò}{{\`O}}1 {Ù}{{\`U}}1
  {ä}{{\"a}}1 {ë}{{\"e}}1 {ï}{{\"i}}1 {ö}{{\"o}}1 {ü}{{\"u}}1
  {Ä}{{\"A}}1 {Ë}{{\"E}}1 {Ï}{{\"I}}1 {Ö}{{\"O}}1 {Ü}{{\"U}}1
  {â}{{\^a}}1 {ê}{{\^e}}1 {î}{{\^i}}1 {ô}{{\^o}}1 {û}{{\^u}}1
  {Â}{{\^A}}1 {Ê}{{\^E}}1 {Î}{{\^I}}1 {Ô}{{\^O}}1 {Û}{{\^U}}1
  {œ}{{\oe}}1 {Œ}{{\OE}}1 {æ}{{\ae}}1 {Æ}{{\AE}}1 {ß}{{\ss}}1
  {ű}{{\H{u}}}1 {Ű}{{\H{U}}}1 {ő}{{\H{o}}}1 {Ő}{{\H{O}}}1
  {ç}{{\c c}}1 {Ç}{{\c C}}1 {ø}{{\o}}1 {å}{{\r a}}1 {Å}{{\r A}}1
  {€}{{\euro}}1 {£}{{\pounds}}1 {«}{{\guillemotleft}}1
  {»}{{\guillemotright}}1 {ñ}{{\~n}}1 {Ñ}{{\~N}}1 {¿}{{?`}}1
}


\definecolor{mygreen}{rgb}{0,0.6,0}
\definecolor{mygray}{rgb}{0.5,0.5,0.5}
\definecolor{mymauve}{rgb}{0.58,0,0.82}

\lstdefinelanguage{ctepebd}
{
morekeywords={AMBIENTE,BIOCARBURANTE,BIOMASA,BIOMASADENSIFICADA,CARBON,ELECTRICIDAD,GASNATURAL,GASOLEO,GLP,RED1,RED2,SOLAR},
morekeywords={[2]PRODUCCION,CONSUMO,EPB,NEPB,RED,INSITU,A,B,COGEN,SUMINISTRO,A_RED,A_NEPB,ACS,CAL,REF,VEN,HU,DHU,ILU,NDEF},
sensitive=false,
morecomment=[l][\color{mygray}]{\#},
morecomment=[l][\color{Coral4}]{\#META}
}

\lstset{ %
  backgroundcolor=\color{yellow!10},   % choose the background color; you must add \usepackage{color} or \usepackage{xcolor}; should come as last argument
  basicstyle=\footnotesize,        % the size of the fonts that are used for the code
  breakatwhitespace=false,         % sets if automatic breaks should only happen at whitespace
  breaklines=true,                 % sets automatic line breaking
  captionpos=t,                    % sets the caption-position to bottom
  commentstyle=\color{mygray},    % comment style
  deletekeywords={...},            % if you want to delete keywords from the given language
  escapeinside={\%*}{*)},          % if you want to add LaTeX within your code
  extendedchars=true,              % lets you use non-ASCII characters; for 8-bits encodings only, does not work with UTF-8
  frame=lines,	                   % adds a frame
  keepspaces=true,                 % keeps spaces in text, useful for keeping indentation of code (possibly needs columns=flexible)
  keywordstyle=\color{blue},       % keyword style
  keywordstyle={[2]\color{Blue4}},       % keyword style
  language=ctepebd,                 % the language of the code
  morekeywords={*,...},            % if you want to add more keywords to the set
  numbers=left,                    % where to put the line-numbers; possible values are (none, left, right)
  numbersep=5pt,                   % how far the line-numbers are from the code
  numberstyle=\tiny\color{mygray}, % the style that is used for the line-numbers
  rulecolor=\color{black},         % if not set, the frame-color may be changed on line-breaks within not-black text (e.g. comments (green here))
  showspaces=false,                % show spaces everywhere adding particular underscores; it overrides 'showstringspaces'
  showstringspaces=false,          % underline spaces within strings only
  showtabs=false,                  % show tabs within strings adding particular underscores
  stepnumber=1,                    % the step between two line-numbers. If it's 1, each line will be numbered
  stringstyle=\color{mymauve},     % string literal style
  tabsize=2,	                   % sets default tabsize to 2 spaces
  title=\lstname                   % show the filename of files included with \lstinputlisting; also try caption instead of title
}

%% FORMATOS PÁGINA ************************************************************
%% ------------ PÁGINA INICIAL
\makeatletter
\def\ps@portada{%
\let\@oddhead\@empty
\let\@evenhead\@empty
\def\@oddfoot{\scriptsize\parbox[b]{4cm}{Versión \version ~/ \fecha \\Página~\textbf{\thepage}~de~ \textbf{\ref*{TotPages}}}\hfill
}%
\def\@evenfoot{\scriptsize\parbox[b]{4cm}{Versión \version ~/ \fecha \\Página~\textbf{\thepage}~de~ \textbf{\ref*{TotPages}}}\hfill
}%
}
\makeatother
%% ------------ PÁGINA plain (para ToC)
\fancypagestyle{plain}{%
\fancyhf{} % clear all header and footer fields
\fancyfoot[L]{\scriptsize\parbox[b]{4cm}{Versión \version ~/ \fecha \\Página~\textbf{\thepage}~de~ \textbf{\ref*{TotPages}}}}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
}
%% ------------ PÁGINA TIPO
\pagestyle{fancy}
\fancyhf{}

\lfoot{\scriptsize \parbox[b]{4cm}{Versión \version ~/ \fecha \\Página~\textbf{\thepage}~de~ \textbf{\ref*{TotPages}}}}
%% FIN FORMATOS ***************************************************************

%% DATOS DEL INFORME **********************************************************
\newcommand{\titulo}{Manual de \texttt{cteepbd}}
\newcommand{\subtitulo}{Programa de cálculo de la eficiencia energética de los edificios\\
para su aplicación al CTE DB-HE (procedimiento EN ISO 52000-1) y formatos de datos}
\newcommand{\titulocorto}{\titulo} % Título para encabezados
%\newcommand{\tipo}{BORRADOR}%{Documento preliminar} % Tipo documento: PRELIMINAR, FINAL, ETC.
\newdateformat{mydate}{\monthname[\THEMONTH] \THEYEAR}
\newcommand{\fecha}{\mydate\today} % Fecha DD/MM/AAAA o \today para hoy
\newcommand{\version}{1.0}
%% FIN DATOS DEL INFORME ******************************************************

\begin{document}

%% PORTADA *****************************************
\thispagestyle{portada}
\null\vspace{5cm}
%\null\vfill % Usamos párrafo nulo ya que vfill/vspace funciona entre párrafos
\begin{center}
{\Large \bfseries \titulo}
\vskip 0pt\vspace{0.5cm}{\large \subtitulo}
%\vskip 0pt\vspace{0.5cm}{\large \tipo}
\end{center}
%\null\vfill

%% NOTA *****************************************
\null\vfill
%%% AUTORES -----------------------------------------
\begin{center} \footnotesize

\fbox{\parbox{.75\textwidth}{
\textbf{\copyright ~ 2018-2022 Ministerio de Fomento}\\
\textbf{\phantom{\copyright ~ 2018-2022 }Instituto de Ciencias de la Construcción Eduardo Torroja (IETcc-CSIC)}\\[5pt]
\textbf{Autores}:\\[5pt]
\-\qquad Grupo de Energética Edificatoria de la Unidad de Calidad en la Construcción (IETcc-CSIC):\\
\-\qquad Rafael Villar Burke \href{mailto:pachi@ietcc.csic.es}{<pachi@ietcc.csic.es>}\\
\-\qquad Daniel Jiménez González \href{mailto:danielj@ietcc.csic.es}{<danielj@ietcc.csic.es>}\\
\-\qquad Marta Sorribes Gil \href{mailto:msorribes@ietcc.csic.es}{<msorribes@ietcc.csic.es>}
}} %% Nombre de los autores del informe

\end{center}
\vskip 0pt\vspace{1.5cm}
\clearpage

\newpage
%% INDICE %%%%%%%%%%%%%%
\tableofcontents
\clearpage

%% DOCUMENTO %%%%%%%%%%%%%%
\newpage
\section{Introducción}

Este manual documenta el programa \texttt{cteepbd}, elaborado por el \textit{Instituto de Ciencias de la Construcción Eduardo Torroja (IETcc-CSIC)} en el marco del convenio vigente con el \textit{Ministerio de Fomento}, que implementa la metodología de cálculo de la eficiencia energética de los edificios descrita en la norma \textit{EN ISO 52000-1:2017} de \textit{Eficiencia energética de los edificios. Evaluación global. Parte 1: Marco general y procedimientos} dentro del alcance de la \textit{Directiva 2010/31/UE} relativa a la \textit{eficiencia energética de los edificios} (\textit{EPDB}).

El objetivo del programa es facilitar la aplicación de la metodología al \textit{Documento Básico de Ahorro de Energía} del \textit{Código Técnico de la Edificación} (\textit{CTE DB-HE}) y la adaptación de las herramientas de evaluación de la eficiencia energética.

El manual describe la interfaz de usuario del programa \textit{cteepbd} y el formato de los archivos de datos de entrada y salida. Los datos de entrada incluyen los valores de producción y consumo energético del edificio, así como los factores de paso empleados para el cálculo, y los de salida, el consumo de energía primaria no renovable, consumo de energía primaria total, emisiones de CO2, entre otros.

El programa calcula la energía suministrada al edificio (desde redes de abastecimiento o producida \textit{in situ}) y la energía exportada (a la red y a usos no EPB) para obtener diversos indicadores de la eficiencia energética del edificio, expresada como energía ponderada, tomando en consideración los factores de paso de los distintos vectores energéticos y el factor de exportación ($k_{exp}$).

\begin{myquote}\footnotesize
This manual documents the \texttt{cteepbd} application, developed under the current agreement by the \textit{Instituto de Ciencias de la Construcción Eduardo Torroja (IETcc-CSIC)} and the spanish \textit{Ministerio de Fomento}, which implements the calculation methodology in the current draft of the \textit{EN ISO 52000-1:2017} standard, on \textit{Energy performance of buildings - Overarching EPB assessment - Part 1: General framework and procedures}. The standard sets a consistent framework to implement the \textit{EPB Directive recast (2010/31/UE)} on the \textit{energy efficiency of buildings} and this application aims to ease the implementation of the standard in the national building regulations and the adaptation of the existing energy performance evaluation tools.
\\

This manual describes the user interface of the\textit{cteepbd} application and its input and output formats, including the building energy use and generation.
\\

The application evaluates both the delivered and exported energy according to the evaluation framework, taking into consideration the weighting factors for each energy carrier as well as the exported energy factor ($k_{exp}$).
\end{myquote}

\clearpage
\newpage
\section{Uso del programa}
\label{sec:usoprograma}

\subsection{Uso básico}

La interacción con el programa (\texttt{cteepbd}, o \texttt{cteepbd.exe} en sistemas Windows) se produce a través de la línea de comandos (señalada con \$ en este texto) indicando los parámetros deseados, que han de incluir al menos el archivo con los componentes energéticos\footnote{Estos datos se obtienen a partir de los resultados de un programa de evaluación de la eficiencia energética.} y los factores de paso:

\begin{Verbatim}[fontsize=\small]
	$ cteepbd -c test_data/cte_test_carriers.csv -l PENINSULA
\end{Verbatim}
%$

La ejecución del programa procesa el archivo de componentes energéticos
(\texttt{cte\_test\_carriers.csv} en el ejemplo) y emite los resultados por pantalla (balance de energía primaria y emisiones (paso B) en el ejemplo):

\VerbatimInput[fontsize=\small, frame=lines, rulecolor=\color{gray}]{../test_data/output/cte_test_carriers.out}

De forma análoga, el programa permite obtener los resultados anteriores, incrementados con la fracción renovable de la demanda de ACS, obtenida considerando el perímetro próximo, del siguiente modo:

\begin{Verbatim}[fontsize=\small]
	$ cteepbd -c test_data/cte_test_carriers.csv -l PENINSULA --demanda_total_acs 2800 > balance_acs.txt
\end{Verbatim}
%$

\VerbatimInput[fontsize=\small, frame=lines, rulecolor=\color{gray}]{../test_data/output/cte_test_carriers_dem_ACS.out}


\clearpage
\newpage
\subsection{Uso detallado}

\subsubsection{Ayuda del programa}
La llamada al programa sin ningún parámetro o con las opciones \texttt{-h} o \texttt{-{}-help} muestra la ayuda:

\begin{Verbatim}[fontsize=\small]
	$ cteepbd --help
\end{Verbatim}
%$

\VerbatimInput[fontsize=\small, frame=lines, rulecolor=\color{gray}]{../test_data/output/salida_ayuda.txt}

\begin{myquote}\footnotesize
Aunque el programa está concebido para calcular la eficiencia energética con factores de paso y factor exportación arbitrarios, emplea de manera predeterminada valores normativos.

Los resultados obtenidos solamente tienen sentido para la justificación de valores normativos si se utilizan con los parámetros adecuados.
\end{myquote}

\subsubsection{Argumentos de definición de los datos de entrada}

Algunos de los argumentos de la interfaz del programa \texttt{cteepbd} sirven para definir los datos de entrada para el cálculo del balance energético. Estos datos tienen preferencia sobre los parámetros definidos en los metadatos del archivo de definición de componentes energéticos.

\textbf{\texttt{-a, --arearef <AREAREF>}}

Este argumento indica el área de referencia para el cálculo de ratios por superficie. Debe tenerse en cuenta que el balance energético no se calcula repercutido por superficie, sino en valor total, y solamente algunos tipos de salida utilizan este dato para algunos indicadores de eficiencia energética.

\textbf{\texttt{-k, --kexp <KEXP>}}

Este argumento indica el factor de exportación $k_{exp}$ usado para calcular la eficiencia energética. En condiciones \textit{CTE DB-HE} toma el valor $0.0$.

\textbf{\texttt{-c, --archivo\_componentes <ARCHIVO\_COMPONENTES>}}

Este argumento indica la ruta del archivo que define los componentes energéticos sobre los que se realiza el cálculo de la eficiencia energética. Tiene el formato definido en el apartado \nameref{sec:formatocomponentes} e incluye metadatos que pueden definir también algunos parámetros de cálculo, aunque con menor prioridad que las opciones definidas explícitamente a través de la interfaz del programa.

\textbf{\texttt{-f, --archivo\_factores <ARCHIVO\_FACTORES>}}

Este argumento indica la ruta del archivo de definición de los factores de paso para el cálculo de la eficiencia energética. Tiene el formato definido en el apartado \nameref{sec:formatofactorespaso}.
Alternativamente, estos factores de paso pueden definirse mediante una localización (ver argumento \texttt{-l}).

\textbf{\texttt{-l LOCALIZACION}}

Este argumento indica los factores de paso para el cálculo de la eficiencia energética a partir de una localización. Puede tomar los valores \texttt{PENINSULA}, \texttt{CANARIAS}, \texttt{BALEARES} o \texttt{CEUTAMELILLA} para generar los factores de paso reglamentarios correspondientes a dichas zonas \footnote{El \textit{Documento Reconocido del Reglamento de Instalaciones Térmicas en los Edificios (RITE) Factores de emisión de CO2 y coeficientes de paso a energía primaria de diferentes fuentes de energía final consumidas en el sector de edificios en España} del 20/07/2014 y de aplicación desde el 14/01/2016 contiene los valores aplicables en cada uno de los casos.}.

\textbf{\texttt{-{}-cogen COGEN\_ren COGEN\_nren COGEN\_co2}}

Este argumento indica los 3 factores de exportación a la red (parte renovable, parte no renovable y emisiones) de la electricidad cogenerada. Estos factores no necesariamente se definen reglamentariamente y no se pueden deducir de la localización sino que dependen de las características técnicas de la instalación de cogeneración y, por tanto, deben ser definidos por el usuario. Las unidades son $kWh/kWh_f$ y $kg_{CO2e}/kWh_f$ para energía primaria y emisiones, respectivamente.

El ejemplo \texttt{-{}-cogen 0 2.5 0.3} indica que el factor de paso de exportación a la red es de 0 para la parte renovable, de 2.5 para la no renovable y de 0.3 para las emisiones.

\textbf{\texttt{-{}-cogen COGENNEPB\_ren COGENNEPB\_nren COGENNEPB\_co2}}

Este argumento indica los 3 factores de exportación a usos no EPB (parte renovable, parte no renovable y emisiones) de la electricidad cogenerada. Estos factores no necesariamente se definen reglamentariamente y no se pueden deducir de la localización sino que dependen de las características técnicas de la instalación de cogeneración y, por tanto, deben ser definidos por el usuario. Las unidades son $kWh/kWh_f$ y $kg_{CO2e}/kWh_f$ para energía primaria y emisiones, respectivamente.

El ejemplo \texttt{-{}-cogennepb 0 2.5 0.3} indica que el factor de paso de exportación a la red es de 0 para la parte renovable, de 2.5 para la no renovable y de 0.3 para las emisiones.

\textbf{\texttt{-{}-red1 RED1\_ren RED1\_nren RED1\_co2}}

Este argumento indica los 3 factores de paso del vectores energético \texttt{RED1} (paso a energía renovable, paso a energía renovable y emisiones). Este vector resulta útil para modelizar redes de distrito de calor y/o frío y no pueden deducirse de la localización del edificio, siendo por tanto definidos por el usuario a partir de las características técnicas de la red. Las unidades son $kWh/kWh_f$ y $kg_{CO2e}/kWh_f$ para energía primaria y emisiones, respectivamente.

El ejemplo \texttt{-{}-red1 0 1.3 0.3} indica que los factores de paso renovable y no renovable del vector \texttt{RED1} son 0 (parte renovable), 1.3 (parte no renovable) y 0.3 (emisiones).

\textbf{\texttt{-{}-red2 RED2\_ren RED2\_nren RED2\_co2}}

Este argumento indica los 3 factores de paso del vectores energético \texttt{RED2} (paso a energía renovable y paso a energía renovable). Este vector resulta útil para modelizar redes de distrito de calor y/o frío y no pueden deducirse de la localización del edificio, siendo por tanto definidos por el usuario a partir de las características técnicas de la red. Las unidades son $kWh/kWh_f$ y $kg_{CO2e}/kWh_f$ para energía primaria y emisiones, respectivamente.

El ejemplo \texttt{-{}-red1 0 1.3 0.3} indica que los factores de paso renovable y no renovable del vector \texttt{RED2} son 0 (parte renovable), 1.3 (parte no renovable) y 0.3 (emisiones).

\textbf{\texttt{-{}-demanda\_anual\_acs <DEM\_ACS>}}

Este argumento indica la demanda total anual para el servicio de agua caliente sanitaria (ACS), en  $kWh$, usado para calcular el porcentaje de la demanda de ACS de origen renovable en el perímetro próximo. Permite el cálculo del indicador de la sección 4 del DB-HE. Este cálculo puede realizarse solo en aquellos casos en los que no se utiliza para producir ACS electricidad procedente de cogeneración. En el caso de usar biomasa y esta no se combina únicamente con otros consumos de energía ambiente o de red de distrito, puede ser necesario definir el porcentaje de la demanda satisfecha por los sistemas que consumen biomasa usando los metadatos \texttt{CTE\_DEMANDA\_ACS\_PCT\_BIOMASA} y/o \texttt{CTE\_DEMANDA\_ACS\_PCT\_BIOMASADENSIFICADA}.

\subsubsection{Argumentos de salida de valores de entrada modificados}

Estos argumentos permiten obtener una salida en archivos de texto del procesado inicial de los datos de entrada.

\textbf{\texttt{-{}-oc GEN\_ARCHIVO\_COMPONENTES}}

Este argumento indica la ruta de salida del archivo con los componentes preprocesados para realizar el cálculo de la eficiencia energética. El preproceso de los componentes consiste en el completado de los balances definidos implícitamente, tal como la definición de las producciones del vector \texttt{AMBIENTE} que deriven de consumos de ese vector y que no hayan sido definidas explícitamente.

\textbf{\texttt{-{}-of GEN\_ARCHIVO\_FACTORES}}

Este argumento indica la ruta de salida del archivo con los factores de paso generados para el cálculo de la eficiencia energética. Los factores generados incluyen un preproceso que define a partir de la localización, los factores definidos por el usuario o un archivo de factores de paso, todos los factores necesarios para el cálculo, tanto en paso A como en paso B. Esta opción interactúa con la opción \texttt{--no\_simplifica\_fps}.

\subsubsection{Argumentos de salida de resultados}

\textbf{\texttt{-{}-json ARCHIVO\_SALIDA\_JSON}}

Este argumento indica la ruta de salida de un archivo en formato JSON con la información detallada del cálculo de la eficiencia energética. Las propiedades definidas en el objeto se detallan en el apartado \nameref{sec:formatosalida}.

\textbf{\texttt{-{}-txt ARCHIVO\_SALIDA\_TXT}}

Este argumento indica la ruta de salida de un archivo en formato de texto plano, con información general del cálculo de la eficiencia energética. Las propiedades definidas en el objeto se detallan en el apartado \nameref{sec:formatosalida}.

\textbf{\texttt{-{}-xml ARCHIVO\_SALIDA\_XML}}

Este argumento indica la ruta de salida de un archivo en formato XML, con información básica del cálculo de la eficiencia energética. El formato se detalla en el apartado \nameref{sec:formatosalida}.

\subsubsection{Otros argumentos}

\textbf{\texttt{-{}-no\_simplifica\_fps}}

Este argumento evita la simplificación de los factores de paso que de forma predefinida se realiza y que elimina aquellos factores de paso que no son necesarios para evaluar los componentes energéticos de la entrada de datos.

\textbf{\texttt{-{}-licencia}}

Este argumento muestra la licencia de distribución del programa (MIT).


\subsection{Manejo de errores}

\texttt{cteepbd} informa al sistema operativo del resultado de la ejecución del programa mediante códigos de error. Usa un valor 0 cuando la ejecución es correcta (no se han producido errores) y valores distintos de 0 para informar del tipo de error genérico que se ha producido. Además, mientras que los resultados e información del programa se muestran a través de la salida estándar (`stdout`), la información de error, más detallada que los códigos de salida, se emite en la salida estándar (`stderr`). Esto permite redirigir de forma separada la información de error para su procesado.

Actualmente, \texttt{cteepbd} utiliza los siguientes códigos de salida:

\begin{itemize}
\item[0] (\textit{OK}): el programa ha finalizado correctamente
\item[64] (\textit{USAGE}): uso incorrecto del programa
\item[65] (\textit{DATAERR}): datos de entrada incorrectos
\item[73] (\textit{CANTCREAT}): no se puede crear un archivo
\item[74] (\textit{IOERR}): error en la E/S
\end{itemize}

\clearpage
\newpage
\section{Formatos de entrada de datos}

\subsection{Archivo de definición de componentes energéticos}\label{sec:formatocomponentes}

El archivo de definición de componentes energéticos detalla la energía consumida y producida en el edificio en cada intervalo de cálculo, según el sistema asociado, el origen o el uso al que se destina la energía, así como un conjunto de metadatos asociados a dicha información.

Cada línea del archivo define un metadato o un componente energético usando una variante del formato de \textit{valores separados por comas}\footnote{El formato está documentado en el estándar RFC 4180 (\url{https://tools.ietf.org/html/rfc4180}).}. El archivo puede incluir también líneas en blanco y comentarios (líneas que empiezan por \texttt{\#} y que no son metadatos), que se ingnoran al ser procesadas.

\lstinputlisting{../test_data/cte_test_carriers.csv}

\subsubsection{Metadatos}

Las líneas de metadatos asocian un valor a una clave y permiten asociar datos al conjunto de componentes energéticos (p.e el área de referencia del edificio).

Su formato es: el texto \texttt{\#META}, seguido de uno o más espacios, el texto que define la clave (sin espacios intermedios), un separador de dos puntos (\texttt{:}), y el valor asociado (que puede contener cualquier carácter alfanumérico).

En el ejemplo, la siguiente línea define un metadato con clave \texttt{CTE\_AREAREF} y valor \texttt{200.0}:

\lstinputlisting[firstline=5, lastline=5,numbers=none]{../test_data/cte_test_carriers.csv}

Para el archivo de definición de los componentes energéticos se establecen las siguientes claves conocidas de metadatos y los valores que pueden adoptar (todos los valores numéricos usan de separador decimal el punto):

\begin{itemize}
\item \texttt{CTE\_ACS\_DEMANDA\_ANUAL}: valor numérico que indica la demanda anual de ACS (kWh/a) para el cálculo del porcentaje de la demanda de fuentes renovables;
\item \texttt{CTE\_AREAREF}: valor numérico que indica el área de referencia (superficie útil);
\item \texttt{CTE\_KEXP}; valor numérico que indica el factor de exportación;
\item \texttt{CTE\_LOCALIZACION}: cadena de texto que indica la localización que define los factores de paso reglamentarios y puede adoptar los valores: \texttt{CANARIAS}, \texttt{CEUTAMELILLA}, \texttt{BALEARES} o \texttt{PENINSULA};
\item \texttt{CTE\_COGEN}: tres valores numéricos separados por una coma, que indican los factores de paso (energía primaria renovable, no renovable y emisiones) para exportación a la red de electricidad cogenerada;
\item \texttt{CTE\_RED1}: tres valores numéricos separados por una coma, que definen los factores de paso (energía primaria renovable, no renovable y emisiones) de la red de distrito 1 (vector energético \texttt{RED1});
\item \texttt{CTE\_RED2}: tres valores numéricos separados por una coma, que definen los factores de paso (energía primaria renovable, no renovable y emisiones) de la red de distrito 2 (vector energético \texttt{RED2});
\item \texttt{CTE\_DEMANDA\_ACS\_PCT\_BIOMASA}: porcentaje de la demanda de ACS que se cubre con el consumo del vector \texttt{BIOMASA}. Puede ser necesario para el cálculo de la fracción renovable de la demanda de ACS cuando se genere ACS empleando sistemas que consumen biomasa de distinto tipo y/o vectores que no son \texttt{AMBIENTE}, \texttt{RED1}, \texttt{RED2} o \texttt{SOLAR};
\item \texttt{CTE\_DEMANDA\_ACS\_PCT\_BIOMASADENSIFICADA}: porcentaje de la demanda de ACS que se cubre con el consumo del vector \texttt{BIOMASADENSIFICADA}. Puede ser necesario para el cálculo de la fracción renovable de la demanda de ACS cuando se genere ACS empleando sistemas que consumen biomasa de distinto tipo y/o vectores que no son \texttt{AMBIENTE}, \texttt{RED1}, \texttt{RED2} o \texttt{SOLAR};
\end{itemize}

Al hacer una llamada al programa \texttt{cteepbd} los valores definidos en los anteriores metadatos del archivo de componentes tienen preferencia sobre los valores por defecto, pero tienen menor precedencia que los definidos a través de las opciones del programa. Es decir, para el área de referencia se prefiere, en primer lugar, el valor dado a través de la opción \texttt{-a}, en segundo lugar, al valor definido para el metadato de clave \texttt{CTE\_AREAREF} y, en tercer lugar, al valor por defecto de 1,0.

\subsubsection{Componentes energéticos}\label{sec:componentesenergeticos}

\textit{Estructural general}

Los componentes energéticos (producción o consumo) tienen la siguiente estructura de columnas (valores separados por comas):

\begin{itemize}
\item campo \texttt{id}, de identificación del sistema, zona o parte asociada al componente. Si este campo no aparece se supone igual al valor `0` y normalmente se asocia al conjunto del edificio.
\item campo \texttt{vector}, de nombre del vector energético;
\item campo \texttt{tipo}, que indica si se trata de energía producida o consumida;
\item campo \texttt{subtipo}, que identifica el origen de la energía producida o el uso de la energía consumida;
\item campo \texttt{servicio}, que identifica el servicio atendido;
\item campos \texttt{valor}, con un valor numérico (con un punto como separador decimal) para cada paso de tiempo;
\item un campo opcional \texttt{comentario}, que puede contener cualquier texto y no está precedido de una coma, sino de una almohadilla \texttt{\#}.
\end{itemize}

Las dos siguientes líneas definen un componente de producción de energía (sistema 1) y otro componente de consumo de energía (sistema 6):

\begin{lstlisting}
1, ELECTRICIDAD, PRODUCCION, INSITU, NDEF, 34.21, 41.94, 64.94, 73.88, 88.44, 88.64, 91.04, 76.15, 52.84, 39.26, 27.43, 26.26 # PV 5m2 (5kWp)
6, ELECTRICIDAD, CONSUMO, EPB, VEN, 98.74, 89.18, 98.74, 95.55, 98.74, 95.55, 98.74, 98.74, 95.55, 98.74, 95.55, 98.74 # VENTILACIÓN
\end{lstlisting}

\begin{myquote}\small
La definición de los componentes de energía producida y consumida permite obtener un balance de la energía suministrada al edificio y de la energía exportada.

Además del suministro de energía a través de combustibles, deben tenerse en cuenta otros flujos de energía que se consideran también parte de la energía suministrada al edificio y, por tanto, deben reflejarse en componentes de energía producida y/o consumida. Se detallan a continuación, estos otros flujos, clasificados según su perímetro de ubicación (\textit{in situ}, próximo o lejano):

\begin{itemize}
\item \textit{Sistemas o componentes del perímetro \textit{in situ} (on-site)}

\begin{itemize}
\item Sistemas técnicos del edificio situados \textit{in situ} y que producen energía a partir de fuentes renovables;
\item energía solar capturada por paneles solares térmicos;
\item \textit{enfriamiento gratuito} como energía renovable;
\item \textit{calentamiento gratuito}, como energía renovable;
\item calor del medioambiente capturado por bombas de calor;
\item electricidad producida por aerogeneradores.
\end{itemize}

\item \textit{Sistemas o componentes del perímetro \textit{próximo} (nearby)}

\begin{itemize}
\item Calor suministrado a través de una red de distrito;
\item Refrigeración suministrada a través de una red de distrito;
\item Calor producido con biomasa sólida (normal o densificada).
\end{itemize}

\item \textit{Sistemas o componentes del perímetro \textit{lejano} (distant)}

\begin{itemize}
\item Producción eléctrica a partir de fuentes renovables.
\item Producción de energía a partir de biogas o biocombustibles.
\end{itemize}
\end{itemize}

\textbf{NOTA:} La energía renovable pasiva (efectos sobre la demanda) no se considera a estos efectos como energía suministrada.
\end{myquote}

\textit{Identificador de componente (\texttt{id})}

Este identificador permite ligar un componente a una zona, sistema o parte específica del edificio.

De forma predefinida, el valor 0 se refiere a la globalidad del edificio, mientras que los valores negativos se utilizarían para referirse a elementos ficticios (sistemas de referencia, demanda del edificio de referencia).

\textit{Vectores energéticos (\texttt{vector})}

La lista de vectores energéticos posibles es la siguiente:

\begin{multicols}{3}
\begin{itemize}
\item \texttt{AMBIENTE}
\item \texttt{BIOMASA}
\item \texttt{BIOMASADENSIFICADA}
\item \texttt{BIOCARBURANTE}
\item \texttt{CARBON}
\item \texttt{ELECTRICIDAD}
\item \texttt{GASOLEO}
\item \texttt{GLP}
\item \texttt{GASNATURAL}
\item \texttt{RED1}
\item \texttt{RED2}
\item \texttt{SOLAR}
\end{itemize}
\end{multicols}

Los vectores \texttt{RED1} y \texttt{RED2} están representan vectores energéticos genéricos, cuyos factores de paso están definidas por el suministrador, y corresponden a redes de distrito de frío y/o calor.

El vector energético \texttt{AMBIENTE} representa la energía ambiente capturada por bombas de calor.

El vector energético \texttt{SOLAR} representa la energía solar térmica recogida por paneles solares térmicos.

\textit{Tipos (\texttt{tipo})}

El tipo de componente energético puede tomar los valores:

\begin{itemize}
\item \texttt{PRODUCCION} para un componente de energía producida
\item \texttt{CONSUMO} para un componente de energía consumida.
\end{itemize}

\textit{Subtipos (\texttt{subtipo})}

Dependiendo del tipo de componente puede definir el el origen de la energía producida o el uso de la energía consumida.

\begin{itemize}
\item Para componentes de \textbf{producción} de energía puede adoptar los valores:
\begin{itemize}
\item \texttt{INSITU}, para vectores producidos \textit{in situ} (energía térmica o electricidad de procedencia solar, electricidad generada con el viento o energía térmica extraída del medioambiente con bombas geotérmicas, aerotérmicas o hidrotérmicas);
\item \texttt{COGEN} para la electricidad procedente de sistemas de cogeneración.
\end{itemize} 

\item Para componentes de \textbf{consumo} de energía el subtipo puede tomar los valores:

\begin{itemize}
\item \texttt{EPB}, cuando la energía consumida se destine a servicios considerados EPB (calefacción, refrigeración, ventilación y ACS en el caso de uso residencial y también la iluminación para uso terciario)\footnote{Se entienden incluidos también en los servicios EPB la humidificación y deshumidificación.};
\item \texttt{NEPB}, para el resto de servicios.
\end{itemize}

\end{itemize}

\textit{Servicios atendidos (\texttt{servicio})}

El servicio al que se destina la producción o que genera el consumo puede tomar los siguientes valores:

\begin{itemize}
\item \texttt{ACS} - Agua caliente sanitaria
\item \texttt{CAL} - Calefacción
\item \texttt{REF} - Refrigeración
\item \texttt{VEN} - Ventilación
\item \texttt{ILU} - Iluminación
\item \texttt{HU} - Humidificación
\item \texttt{DHU} - Deshumidificación
\item \texttt{BAC} - Automatización y control del edificio
\item \texttt{NDEF} - Sin servicio de destino definido
\end{itemize}

\textbf{Nota:} Para el caso de la producción del vector energético \texttt{ELECTRICIDAD}, por las características de su distribución, no se contempla en la versión actual la posibilidad de asignar un servicio específico, tomándose siempre como servicio de destino \texttt{NDEF}, que adjudica la producción a los distintos servicios en función del porcentaje que representan respecto al consumo total de \texttt{ELECTRICIDAD}.
\textbf{Nota:} En algunos casos, los consumos de algunos servicios pueden estar combinados. Por ejemplo, el consumo de humidificación puede estar incluido en el de calefacción, el de deshumidificación en el de refrigeración o el de ventilación en los de calefacción y/o refrigeración.

\textit{Valores (\texttt{valor})}

Los consumos o producciones en cada intervalo de tiempo se definen a través de valores numéricos separados por comas, usando como separador decimal el punto. Debe definirse un valor para cada uno de los intervalos de tiempo considerados (12 para un periodo anual con intervalos de cálculo mensuales).

Todos los registros deben emplear número igual de pasos de tiempo.

\textit{Comentario (\texttt{comentario})}

Este campo, con valor descriptivo, no está delimitado por un signo de coma previo sino precedido por un signo de almohadilla (\texttt{\#}) y puede contener un texto arbitrario, que no se tiene en cuenta en el cálculo.

\textbf{Nota:} En el caso de que el comentario incluya la cadena \texttt{CTEEPBD\_EXCLUYE\_AUX\_ACS}, \texttt{CTEEPBD\_AUX}  o \texttt{CTEEPBD\_EXCLUYE\_SCOP\_ACS} el componente es descartado para el cálculo de la fracción renovable de la demanda de ACS. Esto permite descartar dichos consumos (eléctricos y de energía ambiente, respectivamente) en la contribución a la demanda de ACS. Esto permite, por un lado, el cálculo de más casos con generación renovable de ACS (diferente de la electricidad), para los que no se cumpliría la restricción para el cálculo de la fracción renovable de la demanda de ACS de que no se empleen más de dos vectores energéticos con procedencia en la red, y, por otro lado, excluir las aportaciones de energía ambiente de equipos con un SCOP inferior al mínimo para ser considerada una aportación renovable.

\clearpage
\newpage
\subsection{Archivo de definición de factores de paso}\label{sec:formatofactorespaso}

El archivo de definición de factores de paso detalla los coeficientes de conversión de energía final a energía primaria (parte renovable  y parte no renovable) y de energía final a emisiones, en función del paso de cálculo y el destino de la energía, así como un conjunto de metadatos asociados a dicha información.

Cada línea del archivo define un metadato o un tres de factores de paso (parte renovable, parte no renovable y emisiones) usando una variante del formato de \textit{valores separados por comas}\footnote{El formato está documentado en el estándar RFC 4180 (\url{https://tools.ietf.org/html/rfc4180}).}. El archivo puede incluir también líneas en blanco y comentarios (líneas que empiezan por \texttt{\#} y que no son metadatos), que se ingnoran al ser procesadas.

\begin{myquote}\small
\textbf{NOTA:} El programa \texttt{cteepbd} está preparado para funcionar con cualquier conjunto de factores de paso que pueda definir el usuario, pero está orientado a su uso, mediante opciones, con los definidos en el \textit{Documento Reconocido del Reglamento de Instalaciones Térmicas en los Edificios (RITE) Factores de emisión de CO2 y coeficientes de paso a energía primaria de diferentes fuentes de energía final consumidas en el sector de edificios en España} del 20/07/2014 y de aplicación desde el 14/01/2016. Estos factores son los utilizados también en el DB-HE 2013.
\end{myquote}

A continuación se muestra el archivo que correspondería a la definición de los factores de paso peninsulares:

\lstinputlisting{../test_data/factores_paso_PENINSULA_20140203.csv}

\subsubsection{Metadatos}

Las líneas de metadatos asocian un valor a una clave y permiten asociar datos al conjunto de componentes energéticos (p.e el área de referencia del edificio).

Su formato es: el texto \texttt{\#META}, seguido de uno o más espacios, el texto que define la clave (sin espacios intermedios), un separador de dos puntos (\texttt{:}), y el valor asociado (que puede contener cualquier carácter alfanumérico).

En el ejemplo, la siguiente línea define un metadato con clave \texttt{CTE\_LOCALIZACION} y valor \texttt{PENINSULA}:

\lstinputlisting[firstline=3, lastline=3,numbers=none]{../test_data/factores_paso_PENINSULA_20140203.csv}

Para el archivo de definición de factores de paso se establecen las siguientes claves conocidas de metadatos y los valores que pueden adoptar (todos los valores numéricos usan de separador decimal el punto):

\begin{itemize}
\item \texttt{CTE\_FUENTE}: cadena de texto que define el origen de los datos de factores de paso (actualmente puede tomar el valor \texttt{RITE2014});
\item \texttt{CTE\_FUENTE\_COMENTARIO}; cadena de texto que incluye información adicional sobre la fuente de datos;
\item \texttt{CTE\_LOCALIZACION}: cadena de texto que indica la localización que define los factores de paso reglamentarios y puede adoptar los valores: \texttt{CANARIAS}, \texttt{CEUTAMELILLA}, \texttt{BALEARES} o \texttt{PENINSULA};
\end{itemize}

\subsubsection{Factores de paso}

Los factores de paso tienen la siguiente estructura de columnas (valores separados por comas):

\begin{itemize}
\item campo \texttt{vector}, con el nombre del vector energético, y que puede tener los mismos valores que los vectores definidos para los componentes energéticos (ver sección \nameref{sec:componentesenergeticos});
\item campo \texttt{origen}, que define el origen de la energía: la red de suministro (\texttt{RED}), producción \textit{in situ} (\texttt{INSITU}) o cogeneración (\texttt{COGEN});
\item campo \texttt{destino}, que identifica el destino de la energía: suministro al edificio (\texttt{input}), usos no EPB (\texttt{to\_nEPB}) o la red de suministro (\texttt{to\_grid});
\item campo \texttt{paso}, que identifica los recursos evaluados: los recursos empleados para obtener una unidad del vector energético (paso \texttt{A}), o el impacto en la red al emplear el vector energético en lugar de usar el vector energético desde la red de suministro (paso \texttt{B});
\item campos \texttt{parte renovable}, el factor de paso desde energía final a la parte renovable de la energía primaria utilizada;
\item campos \texttt{parte no renovable}, el factor de paso desde energía final a la parte no renovable de la energía primaria utilizada;
\item campos \texttt{emisiones}, el factor de paso desde energía final a emisiones de CO2;
\item un campo opcional \texttt{comentario}, que puede contener cualquier texto y no está separado del contenido precedente por una coma sino por una almohadilla \texttt{\#}.
\end{itemize}

Las siguiente línea define, por ejemplo,  los factores de paso para la energía eléctrica obtenida desde la red de suministro, en el paso A:

\lstinputlisting[firstline=18, lastline=18,numbers=none]{../test_data/factores_paso_PENINSULA_20140203.csv}

Así, el suministro de 1kWh de electricidad procedente de la red supone el consumo 0,414~kWh de energía primiaria renovable, de 1.954~kWh de energía primaria no renovable y la emisión de 0,331~kg de CO2.

\clearpage
\newpage
\section{Formatos de salida de resultados}\label{sec:formatosalida}

\subsection{Indicadores}

La norma \textit{EN ISO 52000-1} establece, entre otros, los indicadores de eficiencia energética de los edificios: \textit{consumo total de energía primaria} (\texttt{$C_{ep,tot}$}), \textit{porcentaje de energía primaria renovable del consumo total de energía} (\texttt{$RER$}) y las \textit{emisiones de $CO_{2e}$} (\texttt{$CO_{2e}$}).

El programa ofrece, además de dichos indicadores (para los pasos A y A+B), la descomposición consumo total de energía primaria en su parte renovable (\texttt{$C_{ep,ren}$}) y no renovable (\texttt{$C_{ep,nren}$}) y las emisiones de CO2 (\texttt{$E_{CO2}$}), como se muestra en la \autoref{tab:indicadoresFinales}.

\begin{table}[H]
\centering
\small
\caption{Indicadores de la eficiencia energética obtenidos con el programa}\label{tab:indicadoresFinales}
\begin{tabular}{ll}
    \toprule
    \textbf{Indicador} & \textbf{Descripción}\\
    \midrule
    $C_{ep,ren}$ & Parte renovable del consumo de energía primaria total\\
    $C_{ep,nren}$& Parte no renovable del consumo de energía primaria total\\
    $C_{ep,tot}$ & Consumo total de energía primaria\\
    $RER$      & Fracción de energía primaria renovable en el consumo total\\
    $E_{CO2e}$ & Emisiones de $CO_{2e}$\\
    \bottomrule
\end{tabular}
\end{table}

Además de estos resultados, la salida del programa muestra datos de la entrada con la que han sido obtenido los resultados y otros datos intermedios (balances por vectores energéticos, balances por servicios, energía usada en servicios EPB, energía exportada a servicios no EPB o a la red, energía total producida, etc).

\subsection{Salida simple}

Esta salida se emite siempre a través de la salida estándar y se puede redirigir a un archivo, tal como se describe en la \autoref{sec:usoprograma}, de \nameref{sec:usoprograma}.

La salida muestra los datos de entrada, con un nivel de detalle dependiente de las opciones de llamada al programa pero sin datos intermedios y los resultados básicos de consumo en el paso B (energía primaria y emisiones), tanto en valor absoluto como en valor repercutido por superficie.

Además, se muestran los valores repercutidos por superficie y desglosados por servicios del consumo de energía final (solo para usos EPB) y del consumo de energía primaria y las emisiones.

A continuación se muestra un ejemplo de la salida simple que genera el ejemplo \texttt{cte\_test\_carriers.csv}:

\lstinputlisting[language=]{../test_data/output/balance.plain}

\newpage
\subsection{Salida en formato XML}
\label{subsec:formatoxml}

Esta salida guarda la información en el formato XML.

La salida incluye los componentes energéticos (vectores), los factores de paso (fps), el factor de exportación (kexp), el área de referencia (arearef) y el balance final en paso B (ep) en términos de energía primaria repercutida por superficie  con los que se han obtenido los resultados.

A continuación se muestra la salida en el formato XML para el mismo caso anterior:

\lstinputlisting[language=XML]{../test_data/output/balance.xml}

\newpage
\subsection{Salida en formato JSON}
\label{subsec:formatojson}

Esta salida guarda la información en la notación de objetos de JavaScript (JSON) y permite obtener el mayor nivel de información disponible para la aplicación.

La \textbf{estructura de salida} incluye las siguientes claves, descritas en términos de energía primaria pero que, dependiendo del tipo de factores de paso, se podrían interpretar en términos de emisiones:

\begin{itemize}
\item \texttt{components} - los componentes energéticos;
\item \texttt{wfactors} - los factores de paso;
\item \texttt{k\_exp} - el factor de exportación;
\item \texttt{arearef} - el área de referencia;
\item \texttt{balance\_cr} - el balance energético para cada intervalo de cálculo y por vector energético;
\item \texttt{balance} - el balance global;
\item \texttt{balance\_m2} - el balance global repercutido por superficie.
\item \texttt{misc} - indicadores adicionales
\end{itemize}

El \textbf{factor de exportación} y el \textbf{área de referencia} tienen una representación trivial en la salida JSON, mientras que los \textbf{componentes energéticos} y \textbf{factores de paso} tienen una representación que es una traducción directa del formato de entrada indicado en los apartados correspondientes de este manual.

El \textbf{balance energético por vector energético} (\texttt{balance\_cr}) incluye, para cada vector energético:

\begin{itemize}
\item \texttt{carrier} - el nombre del vector energético;
\item \texttt{used\_EPB} - la energía destinada a usos EPB, para cada intervalo;
\item \texttt{used\_EPB\_an\-byuse} - la energía destinada a usos EPB, por servicio y en total anual;
\item \texttt{used\_nEPB} - la energía destinada a usos no EPB, para cada intervalo;
\item \texttt{produced} - la energía producida, para cada intervalo;
\item \texttt{produced\_an} - la energía producida, en total anual;
\item \texttt{produced\_by_source} - la energía producida, por origen y para cada intervalo;
\item \texttt{produced\_by_source\_an} - la energía producida, por origen y en total anual;
\item \texttt{produced\_used\_EPus} - la energía producida y usada en usos EPB, para cada intervalo;
\item \texttt{produced\_used\_EPus\_by_source} - la energía producida y usada en usos EPB, por origen y para cada intervalo;
\item \texttt{f\_match} - el factor de coincidencia de cargas (producción y consumo);
\item \texttt{exported} - la energía exportada, para cada intervalo;
\item \texttt{exported\_an} - la energía exportada anualmente, en total anual;
\item \texttt{exported\_by_source} - la energía exportada, por origen y para cada intervalo;
\item \texttt{exported\_by_source\_an} - la energía exportada, por origen, en total anual;
\item \texttt{exported\_grid} - la energía exportada a la red, para cada intervalo;
\item \texttt{exported\_grid\_an} - la energía exportada a la red, en total anual;
\item \texttt{exported\_nEPB} - la exportada a usos no EPB, para cada intervalo;
\item \texttt{exported\_nEPB\_an} - la energía exportada a usos no EPB, en total anual;
\item \texttt{delivered\_grid} - la energía suministrada por la red, para cada intervalo;
\item \texttt{delivered\_grid\_an} - la energía suministrada por la red, en total anual;
\item \texttt{we\_delivered\_grid\_an} - la energía ponderada suministrada por la red, en total anual;
\item \texttt{we\_delivered\_prod\_an} - la energía ponderada suministrada por producción, en total anual;
\item \texttt{we\_delivered\_an} - la energía ponderada suministrada, en total anual;
\item \texttt{we\_exported\_an\_A} - la energía ponderada exportada en el paso A, en total anual;
\item \texttt{we\_exported\_nEPB\_an\_AB} - la energía ponderada exportada para usos no EPB en el paso AB, en total anual;
\item \texttt{we\_exported\_grid\_an\_AB} - la energía ponderada exportada a la red en el paso AB, en total anual;
\item \texttt{we\_exported\_an\_AB} - la energía ponderada exportada en el paso AB, en total anual;
\item \texttt{we\_exported\_an} - la energía ponderada exportada en el paso B, en total anual;
\item \texttt{we\_an\_A} - la energía ponderada en el paso A, en total anual;
\item \texttt{we\_an\_A\_by_service} - la energía ponderada en el paso A, por servicio EPB y en total anual;
\item \texttt{we\_an} - la energía ponderada en el paso B, en total anual;
\item \texttt{we\_an\_by_service} - la energía ponderada en el paso B, por servicio EPB y en total anual.
\end{itemize}

\begin{myquote}\small
Esta salida permite, por ejemplo, calcular la energía eléctrica producida y autoconsumida como:
\\

\texttt{balance\_cr.ELECTRICIDAD.produced\_an - balance\_cr\_i.ELECTRICIDAD.exported\_grid\_an}
\\

o, como suma de los valores de los valores de los intervalos mensuales en:
\\

\texttt{balance\_cr.ELECTRICIDAD.produced\_used\_EPus}
\end{myquote}

El \textbf{balance global} (\texttt{balance}) y el \textbf{balance global repercutido por superficie} \texttt{balance\_m2} contiene la siguiente información, obtenida de la agregación de los resultados parciales de cada vector energético:

\begin{itemize}
\item \texttt{used\_EPB\_by_service} - Energía usada para servicios EPB, por servicio, en total anual
\item \texttt{A} - Energía ponderada en el paso A, en total anual
\item \texttt{A\_by_service} - Energía ponderada en el paso A, por servicio EPB y en total anual
\item \texttt{B} - Energía ponderada en el paso A+B, en total anual
\item \texttt{B\_by_service} - Energía ponderada en el paso B, por servicio EPB y en total anual
\item \texttt{we\_del} - Energía ponderada suministrada, en total anual
\item \texttt{we\_exp\_A} - Energía ponderada exportada en el paso A, en total anual
\item \texttt{we\_exp} - Energía ponderada exportada en el paso A+B, en total anual
\end{itemize}

En los balances globales, los indicadores de energía ponderada se expresan separando la parte renovable (\texttt{ren}) de la no renovable (\texttt{nren}).

La clave de \textbf{indicadores adicionales} (\texttt{misc}) contiene datos organizados como un diccionario (hashmap) de longitud no determinada (puede ser \texttt{null}) con clave y valor de tipo texto.

En la versión actual del programa se emiten los siguientes valores:

\begin{itemize}
\item \texttt{fraccion\_renovable\_demanda\_acs\_nrb} - Fracción de la demanda de ACS con origen renovable considerando el perímetro próximo. Se calcula únicamente cuando se usa la opción \texttt{-{}-demanda\_anual\_acs} o se incluye el metadato \texttt{CTE\_ACS\_DEMANDA\_ANUAL} y se cumplen las restricciones para su cálculo en cuanto al origen de la energía usada. Se almacena como un texto que contiene un número decimal y se expresa en tanto por uno.
\item \texttt{demanda\_anual\_acs} - Demanda anual de ACS aportada con la opcion \texttt{-{}-demanda\_anual\_acs}. Se almacena como texto y se expresa en $kWh$.
\end{itemize}

\subsubsection{Ejemplo de salida en formato JSON}

A continuación se muestra la salida en el formato JSON, para el caso anterior, incluyendo la información adicional (clave \texttt{misc} distinta a \texttt{null}):

\lstset{
    string=[s]{"}{"},
    stringstyle=\color{blue},
    comment=[l]{:},
    commentstyle=\color{black},
}
\lstinputlisting{../test_data/output/balance_dem_acs.json}

\clearpage
\newpage

%%% ANEXOS *******************************************************************************

\setcounter{section}{0} % resetear contador de secciones
\renewcommand\thesection{Anexo~\Roman{section}}
\renewcommand\theHsection{Anexo~\Roman{section}}
\renewcommand\thesubsection{\Roman{section}.\arabic{subsection}}
\renewcommand\theHsubsection{\Roman{section}.\arabic{subsection}}
\renewcommand{\thefigure}{\Roman{section}.\arabic{figure}}
\renewcommand{\theHfigure}{\Roman{section}.\arabic{figure}}
\renewcommand{\thetable}{\Roman{section}.\arabic{table}}
\renewcommand{\theHtable}{\Roman{section}.\arabic{table}}

\section{Ejemplos}
\label{sec:anexoejemplos}
\setcounter{figure}{0} % resetear contador por sección
\setcounter{table}{0} % resetear contador por sección

Para ilustrar el funcionamiento del programa se han implementado algunos ejemplos del anejo J del documento \textit{ISO/TR 52000-2:2016} que acompaña a la norma, aunque se muestran aquí en condiciones reglamentarias (factor de exportación igual a 0 y factores de paso peninsulares). Los ejemplos usan generalmente, por simplicidad, un intervalo de cálculo anual con un solo valor, y no 12 valores correspondientes a un intervalo de cálculo mensual.

Las llamadas al programa para calcular el caso se realizarían usando:

\begin{Verbatim}[fontsize=\small]
    $ cteepbd -c ruta/archivo_componentes_caso.csv -l PENINSULA
\end{Verbatim}
%$

\subsection{Ejemplo J1: Sistema totalmente eléctrico}
El ejemplo 1 es un sistema en el que todos los sistemas del edificio funcionan con un único vector energético, la electricidad, y no hay aportes de otro tipo. Esto excluye a las bombas de calor, puesto que en ese caso se consideraría que el medioambiente aporta otro vector energético. El consumo en servicios EPB es de 100 kWh y no se considera consumo para otros usos.

\lstinputlisting[title={\textcolor{gray}{\footnotesize Componentes energéticos: ejemploJ1\_base.csv}}]{../test_data/ejemploJ1_base.csv}

\lstinputlisting[language=, title={\textcolor{gray}{\footnotesize Resultados: ejemploJ1\_base.out}}]{../test_data/output/ejemploJ1_base.out}


\subsection{Ejemplo J2: Sistema eléctrico con producción fotovoltaica}

Este caso es una variante del caso anterior, y añade producción de energía fotovoltaica (\textit{in situ}) por un valor de la mitad de lo consumido en usos EPB, de 50 kWh.

\lstinputlisting[title={\textcolor{gray}{\footnotesize Componentes energéticos: ejemplos/ejemploJ2\_basePV.csv}}]{../test_data/ejemploJ2_basePV.csv}

\lstinputlisting[language=, title={\textcolor{gray}{\footnotesize Resultados: ejemploJ2\_basePV.out}}]{../test_data/output/ejemploJ2_basePV.out}

\subsection{Ejemplo J3: Sistema eléctrico con producción de energía fotovoltaica y exportación a la red}

Este caso también es una variante del anterior, con un sistema fotovoltaico que produce más energía de la que se demanda para cubrir los servicios EPB.

\lstinputlisting[title={\textcolor{gray}{\footnotesize Componentes energéticos: ejemplos/ejemploJ3\_basePVexcess.csv}}]{../test_data/ejemploJ3_basePVexcess.csv}

\lstinputlisting[language=, title={\textcolor{gray}{\footnotesize Resultados: ejemploJ3\_basePVexcess.out}}]{../test_data/output/ejemploJ3_basePVexcess.out}

\subsection{Ejemplo J5: Sistema de gas natural con apoyo eléctrico y producción fotovoltaica}
En el ejemplo J5 la demanda energética es cubierta con una caldera que consume 190 kWh de gas natural, existiendo un consumo eléctrico auxiliar de 20 kWh. Además, existe una instalación fotovoltaica que aporta 40 kWh anuales.

\lstinputlisting[title={\textcolor{gray}{\footnotesize Componentes energéticos: ejemplos/ejemplos/ejemploJ5\_gasPV.csv}}]{../test_data/ejemploJ5_gasPV.csv}

\lstinputlisting[language=, title={\textcolor{gray}{\footnotesize Resultados: ejemploJ5\_gasPV.out}}]{../test_data/output/ejemploJ5_gasPV.out}

\subsection{Ejemplo J6: Sistema de bomba de calor con apoyo fotovoltaico.}
El ejemplo J6 recoge el caso de un sistema con bomba de calor que cubre toda la demanda de servicios EPB. Esta bomba de calor eléctrica consume 59 kWh, de los cuales 40 son de origen fotovoltaico, y permiten al equipo extraer 131 kWh de calor procedente del medio ambiente que se destinan a usos EPB.

\lstinputlisting[title={\textcolor{gray}{\footnotesize Componentes energéticos: ejemplos/ejemplos/ejemploJ6\_HPPV.csv}}]{../test_data/ejemploJ6_HPPV.csv}

\lstinputlisting[language=, title={\textcolor{gray}{\footnotesize Resultados: ejemploJ6\_HPPV.out}}]{../test_data/output/ejemploJ6_HPPV.out}

\subsection{Ejemplo J7: Caldera y sistema de cogeneración con combustible fósil.}
En el ejemplo J7 incluye una caldera de gas natural que consume 100 kWh y una máquina de cogeneración que consume 158 kWh, también de gas natural. Como resultado de la cogeneración se generan 47,4 kWh de electricidad de los cuales 27,4 kWh son exportados a la red y 20 kWh son consumidos en servicios EPB.

\lstinputlisting[title={\textcolor{gray}{\footnotesize Componentes energéticos: ejemplos/ejemplos/ejemploJ7\_cogenfuelgasboiler.csv}}]{../test_data/ejemploJ7_cogenfuelgasboiler.csv}

\lstinputlisting[language=, title={\textcolor{gray}{\footnotesize Resultados: ejemploJ7\_cogenfuelgasboiler.out}}]{../test_data/output/ejemploJ7_cogenfuelgasboiler.out}

\subsection{Ejemplo J8: Caldera y sistema de cogeneración con combustible renovable}
Este ejemplo J8 varía respecto al anterior en que los 158 kWh que consume el sistema de cogeneración provienen de biogas.

\lstinputlisting[title={\textcolor{gray}{\footnotesize Componentes energéticos: ejemplos/ejemplos/ejemploJ8\_cogenbiogasboiler.csv}}]{../test_data/ejemploJ8_cogenbiogasboiler.csv}

\lstinputlisting[language=, title={\textcolor{gray}{\footnotesize Resultados: ejemploJ8\_cogenbiogasboiler.out}}]{../test_data/output/ejemploJ8_cogenbiogasboiler.out}

\subsection{Ejemplo J9: Cálculo con intervalo mensual}
Este ejemplo J9 muestra un caso completamente eléctrico y con usos no EPB pero detallado con intervalo de cálculo mensual.

\lstinputlisting[title={\textcolor{gray}{\footnotesize Componentes energéticos: ejemplos/ejemplos/ejemploJ9\_electr.csv}}]{../test_data/ejemploJ9_electr.csv}

\lstinputlisting[language=, title={\textcolor{gray}{\footnotesize Resultados: ejemploJ9\_electr.out}}]{../test_data/output/ejemploJ9_electr.out}

\clearpage
\newpage
\section{Integración de la herramienta \texttt{cteepbd} con programas de simulación para el cumplimiento del CTE DB-HE}
\label{sec:anexointegracion}
\setcounter{figure}{0} % resetear contador por sección
\setcounter{table}{0} % resetear contador por sección

Este apéndice detalla aquellos aspectos más relevantes para la integración de la herramienta \texttt{cteepbd} con programas de simulación energética orientada al cumplimiento del \textit{CTE DB-HE}.

\subsection{Preparación de los datos de entrada}

Los programas de simulación energética son los responsables de realizar el cálculo de la energía final consumida por el edificio y de la energía final producida.

Además de respetar el formato descrito en la sección \textit{\nameref{sec:formatocomponentes}}, el archivo de componentes energéticos debe incluir\footnote{Condiciones de acuerdo con la propuesta de actualización del DB-HE (2018) publicada para información pública. Estas condiciones podrían variar en función de las modificaciones sufridas tras el periodo de información pública.} la producción de energía obtenida \textit{in situ} (solar térmica, solar fotovoltaica, minieólica, geotérmica, etc) o mediante procesos de cogeneración y el consumo de energía final de los servicios de calefacción, refrigeración, ACS, ventilación y, en el caso de edificios de uso distinto al residencial privado, iluminación.

En particular, debe recalcarse, por no ser habitual este cómputo hasta el momento, que la energía final consumida ha de incluir la energía térmica (renovable) extraída del medioambiente. Por ejemplo, en el caso de una bomba de calor de SPF 2.5, se considera que por cada kWh eléctrico consumido el equipo consume también 1.5 kWh del medioambiente\footnote{Para el cálculo de la energía renovable procedente de las bombas de calor véase la \href{https://www.boe.es/doue/2013/062/L00027-00035.pdf}{Decisión de la Comisión, de 1 de marzo de 2013, por la que se establecen las directrices para el cálculo por los Estados miembros de la energía renovable procedente de las bombas de calor de diferentes tecnologías, conforme a lo dispuesto en el artículo 5 de la Directiva 2009/28/CE del Parlamento Europeo y del Consejo [notificada con el número C(2013) 1082]}.}\footnote{En el caso de las bombas de calor, también hay que tener en cuenta que en el modo de refrigeración el equipo no extrae calor del medioambiente, sino que rechaza la transmisión del calor interno del edificio, de modo que el proceso no es simétrico en términos de energía que atraviesa la frontera de evaluación.}.

En el caso de que existan equipos de cogeneración, debe tenerse en cuenta que el balance de la energía producida y consumida incluye el consumo del combustible o vector energético usado para la cogeneración y la producción eléctrica con origen en la cogeneración. Dado que la energía térmica es producida y consumida \textit{in situ}, esta no atraviesa el perímetro de evaluación y, por tanto, no figura en el balance. En caso necesario, la imputación del consumo del combustible para la cogeneración puede realizarse a los servicios térmicos o eléctricos en función del rendimiento térmico y eléctrico, y debe reflejarse coherentemente en los factores de paso asignados a la electricidad procedente de la cogeneración\footnote{Para la asignación de factores de paso y el cálculo de la energía eléctrica y térmica producida, véanse los Anexos I y II de la \href{https://www.boe.es/buscar/doc.php?id=DOUE-L-2012-82191}{Directiva 2012/27/UE del Parlamento Europeo y del Consejo, de 25 de octubre de 2012, relativa a la eficiencia energética, por la que se modifican las Directivas 2009/125/CE y 2010/30/UE, y por la que se derogan las Directivas 2004/8/CE y 2006/32/CE}, la \href{https://www.boe.es/buscar/doc.php?id=DOUE-L-2008-82509}{Decisión de la Comisión, de 19 de noviembre de 2008, por la que se establecen orientaciones detalladas para la aplicación del anexo II de la Directiva 2004/8/CE del Parlamento Europeo y del Consejo [notificada con el número C(2008) 7294]}, y el apartado \textit{9.6.6 Factores de paso} de la \textit{UNE EN ISO 52000-1}.}.


\subsection{Llamada al programa y salida de resultados}

El programa está pensado para ser llamado mediante un subproceso independiente, suministrando como parámetros, al menos, el archivo de componentes energéticos (p.e. \texttt{-c ''componentes.cteepbd''}) y la localización (p.e. \texttt{-l PENINSULA}) del edificio.

\begin{Verbatim}[fontsize=\small]
    $ cteepbd -c ruta/archivo_componentes_caso.csv -l PENINSULA
\end{Verbatim}
%$

El programa genera así una salida simple que puede redirigirse a un archivo para su postproceso por la herramienta de simulación o de cumplimiento reglamentario.

\begin{Verbatim}[fontsize=\small]
    $ cteepbd -c componentes.cteepbd -l PENINSULA > resultados_cteepbd_EP.txt
\end{Verbatim}
%$

También puede usarse la opción de guardado a un archivo de texto plano:

\begin{Verbatim}[fontsize=\small]
    $ cteepbd -c componentes.cteepbd -l PENINSULA --txt resultados_cteepbd_EP.txt
\end{Verbatim}
%$

En general, se recomienda utilizar la salida en formato \textit{JSON} (\autoref{subsec:formatojson}), que es la que contiene información más detallada y esta se recoge en un formato estructurado, fácil de procesar.

\begin{Verbatim}[fontsize=\small]
    $ cteepbd -c componentes.cteepbd -l PENINSULA --json resultados_cteepbd_EP.json
\end{Verbatim}
%$

\subsection{Proceso general}

Para la obtención de datos generales relativos al consumo de energía final, energía primaria y emisiones se realizaría la llamada:

\begin{Verbatim}[fontsize=\small]
    $ cteepbd -c componentes.cteepbd -l PENINSULA --json resultados_cteepbd_EP.json --xml resultados_cteepbd_EP.xml
\end{Verbatim}
%$

Cuando se quiera obtener, además el dato de la fracción de la demanda de origen renovable, obtenida para el permímetro próximo se añadiría la opción \texttt{-{}-demanda\_anual\_acs DEM\_ACS}:

\begin{Verbatim}[fontsize=\small]
    $ cteepbd -c componentes.cteepbd -l PENINSULA --demanda_anual_acs 2800.0 --json resultados_cteepbd_ACS_nrb_EP.json
\end{Verbatim}
%$

En los siguientes subapartados se muestra cómo obtener información sobre los indicadores del \textit{CTE DB-HE} o la certificación energética utilizando esta salida en formato \textit{JSON}. Se hará referencia a los valores del objeto generado usando notación de punto (p.e., \texttt{balance.B.ren} se correponde al valor localizado con la clave \texttt{ren} en el objeto con clave \texttt{B} en el objeto con clave \texttt{balance}, perteneciente al objeto global).

\subsection{Obtención del consumo de energía primaria no renovable y total}

El consumo de energía primaria no renovable, en $kWh/m^2$ se obtiene como resultado directo:

$C_{ep,ren} [kWh/m^2] = \texttt{balance\_m2.B.ren}$

Mientras que el consumo de energía primaria total se obtiene a partir de la suma del la parte renovable y no renovable del consumo:

$C_{ep,tot} [kWh/m^2] = C_{ep,ren} + C_{ep,nren} = \texttt{balance\_m2.B.ren} + \texttt{balance\_m2.B.nren}$

\subsection{Obtención del consumo de energía final por servicios}

El consumo de energía final usada en servicios (sólo servicios EPB) se localiza en el objeto:

$\texttt{balance\_m2.used\_EPB\_by_service}$

donde cada clave indica el servicio y el valor asociado a la clave, el consumo de energía final de dicho servicio, expresado en $kWh/m^2$.

Así, el consumo de energía final del servicio de calefacción se localizaría en:

$\texttt{balance\_m2.used\_EPB\_by_service.CAL}$

\textbf{NOTA:} Debe tenerse en cuenta que únicamente se recogen los servicios para los que existe algún consumo

\subsection{Obtención del consumo de energía primaria por servicios}

El consumo de energía primaria, desagregada por servicios (sólo servicios EPB), se localiza en el objeto:

$\texttt{balance\_m2.B\_by_service}$

donde cada clave indica el servicio y el valor asociado a la clave, el consumo de energía final de dicho servicio, expresado en $kWh/m^2$, y en sus componentes renovable y no renovable.

Así, el consumo de energía primaria no renovable del servicio de calefacción se localizaría en:

$\texttt{balance\_m2.B\_by_service.CAL.nren}$

\textbf{NOTA:} Debe tenerse en cuenta que únicamente se recogen los servicios para los que existe algún consumo.

\subsection{Obtención de la energía eléctrica generada y autoconsumida}

La energía eléctrica generada in situ y autoconsumida (sólo en servicios EPB) se puede obtener a partir del balance para el vector energético \texttt{ELECTRICIDAD}, en la clave de energía consumida en usos EPB:

$\texttt{balance\_cr.ELECTRICIDAD.used\_EPB}$

Dicha clave contiene los valores para cada paso de cálculo de la energía eléctrica usada en servicios EPB, de modo que el valor total anual se obtiene como suma de los valores mensuales.

\subsection{Obtención de las emisiones de CO2 y de las emisiones por servicio}

Los datos relativos a emisiones totales se obtienen en las entradas:

$E_{CO2e} [kg_{CO2}] = \texttt{balance.B.co2}$

y las repercutidas por la superficie de referencia en:

$E_{CO2e} [kg_{CO2_e}/m^2] = \texttt{balance\_m2.B.co2}$

Al igual que en el caso del consumo, es posible obtener los valores desagregados por servicios EPB en los objetos:

$\texttt{balance.B\_by_service}$

o, para valores repercutidos por la superficie útil:

$\texttt{balance\_m2.B\_by_service}$

\subsection{Obtención del porcentaje de la demanda con origen renovable, calculada para el perímetro próximo}

Este dato se obtiene siempre que se invoque la aplicación usando la opción \texttt{-{}-demanda\_anual\_acs DEM\_ACS} o se disponga del metadato \texttt{CTE\_ACS\_DEMANDA\_ANUAL} y se cumplan las limitaciones que actualmente tiene el programa para su obtención (si la producción de ACS se realiza mediante biomasa solamente puede tener contribución de otros vectores producidos \textit{in situ}, y se puede producir ACS mediante electricidad procedente de cogeneración).

El valor del porcentaje se obtiene multiplicando por 100 el dato dado como fracción:

$\%_{dem,ACS,nrb} [\%] = 100 \cdot \texttt{misc.fraccion\_renovable\_demanda\_acs\_nrb}$


\subsection{Obtención del fragmento XML para el Certificado energético}

El programa \texttt{cteepbd} permite obtener el fragmento de \textit{XML} (\autoref{subsec:formatoxml}) con la información relativa a los componentes de consumo y producción de energía, factores de paso y balance energético, que es necesaria para la definición del Certificado energético en formato \textit{XML}.

Para ello basta indicar la salida \texttt{XML}:

\begin{Verbatim}[fontsize=\small]
    $ cteepbd -c componentes.cteepbd -l PENINSULA --xml fragmentocert.xml
\end{Verbatim}
%$

\end{document}
