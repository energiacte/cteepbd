# TODO

- check whether `#[non_exhaustive]` could be useful for some enums (Service?)
- maybe bug: see why emissions for ACS for the manual's example change
  depending on whether nearby factors are used or not.

- cte

  - Test XML output
  - remove obsolete `acsnrb` option (fraccion_renovable_acs is unconditionally computed and added to JSON)
  - wfactors.normalize(defaults): ver si quitamos de aquí los valores por defecto y así podemos generar de forma más ergonómica los factores de paso sin usar wfactors_from_loc
    `CTE_LOCWF_RITE2014.get(loc)?.set_user_wfactors(&user_wf).normalize(&default_user_wf);`
  - Sacar energía final no EPB (ver acs_demanda_ren_con_nepb.csv comentando y descomentando NEPB)
  - Debemos cambiar la definición de servicios EPB dependiendo de si es residencial o no?
    o documentar que no se introducen los no EPB como tales cuando corresponda (p.e. iluminación en residencial) (Poner en manual como nota)

- epbd:

  - How to identify subsystems (generation, distribution, emission, storage) wrt energy use and production?
    - Necsitamos calcular eficiencias por subsistemas (ver más abajo el cálculo) y para eso hay que diferenciarlos
    - Use new format, with id, subsystem, type, source / service, values # comment
      - subsystem (Y): GEN, DIS, EM, STO + otro subsistema de ZONE
        - We can define new object types for distribution, emission and storage, as we don't use them yet.
        - Pensar cómo encaja distribución y almacenamiento? StoIn, StoOut, StoAux, DisIn, DisOut, DisAux, EmIn, EmOut, EmAux
          - Bastaría con indicar las pérdidas y consumos auxiliares en consumo, distribución+almacenamiento y emisión para calcular rendimientos (simplificando Dis+Sto)?
      - type: CONSUMO (Use), PRODUCCION (Prod), CARGA (Out), AUXILIAR (Aux) + DEMANDA (Needs) de ZONE
        - El CONSUMO_AUX se trata igual que el consumo a efectos de balance pero no a efectos de cálculo de los rendimientos por subsistemas eff_i
      - Llevar GEN_OUT a cdata y renombrar a cdata a gen
      - Renombrar GenUse a GenIn???
    - Llevar Zone, Gen, Sto, Dis, Em a tipos, y tener Use, Prod, Out, Aux, Needs... (ZoneNeeds y *Out tienen los mismos datos)
  - Compute system efficiencies (cal, ref?, acs) (and subsystems (generation, distribution, emission, storage))
    - Generic system balance (15613-1, (3)): Q_X_Y_in = Q_X_Y_out + Q_X_ls - Q_X_Y_ls_rvd
      - Q_X_Y_ls_rvd are recovered losses
    - Generic energy efficiency (15613-1 (33)): eff_i = (Q_i_out + f_i · E_el_i_out) / (Q_i_in + f_i · W_i_aux);
      - A conventional weighting factor, f_i=2,5 is used to add up heat and electricity (for comparability reasons)
      - Q_i_in doesn't include heat captured in the evaporator from the heat source for heap pumps -> we get annual COP
    - System balance for heat pumps (15613-4-2, (1), DWH (cal + acs)):
      - E_X_Y_in \* COP = Q_X_Y_out + Q_X_ls_tot - Q_X_Y_in (ambiente) - f_Y;aux;ls;rvd · W_X_Y_aux (EN 15316-4-2:2019, formula 1, DHW, HEATING)
      - Energy_use \* COP = Energy_out + Energy_losses - (Energy_from_heat_source_input + Energy_from_recovered_aux_energy_not_accounted_for_in_COP_input)
      - This is: electr. o combustible \* COP = energía entregada + pérdidas - energía aportada medioambiente (fuente de calor) - pérdidas recuperables
      - Q_X_Y_in = E_X_Y_in \* COP en términos de la EN 15316-1 (1). No considera energía ambiente capturada por la bomba.
      - Para refrigeración ver UNE EN 14825=2016
  - define GEN as a new (nonEPB) service for energy used for cogeneration (see Module M11 in EN 15316)
    - how does it relate to EPB and NEPB services? (where is it accounted for? review filtering in code)
    - Used to attribute carrier use to electricity cogeneration. Check impact in all other computations (could be used to find cogeneration factors).
    - Describe default method to find used energy from electrical efficiency of cogeneration.
  - Define more component types:
    - Energy losses linked to service X (Q_X_ls)
      - PERDIDAS
    - Recovered energy losses linked to service X and subsystem Y (Q_X_Y_ls_rvd)
      - RECUPERADA
    - Number of hours where temperature shedule limits are not met (CAL, REF)
      - HORASFUERACONSIGNA
  - allow using load matching factor values (or functions) that are not 1 (formula 32, B.32)
    Have a look to the proposed value from the TR.
  - JSON input

- tests:

  - cte: check non matching computation modes in component metadata and weighting factors metadata

- output:
  - Additional JSON output generated from the zone (ZONA) and system (SISTEMA) data
    - Energy needs (with annual totals)
    - System efficiencies / indicators
      - See UNE_EN 15316-1 formula (35). Varies by subsystem type
      - ¿Whole building efficiencies by service (non renewable primary energy)?
    - Fraction of energy use covered by renewable sources, by service and by system (id)
      - Calcular % de cobertura renovable (RER_nrb, RER_dst) (consumo EF y demanda) para los distintos servicios
    - ReduccionEPNR y ReduccionEmisiones
    - demanda por servicios y total (¿y demanda de referencia si la hay?)
    - valores totales de los distintos indicadores (Ver BalanceEPB nuevo y ver 52000-1 Tabla 5 para datos por servicio)
    - e.final
      - De todos los servicios y desglosado por servicio
    - balance B, balance A, AB: ren, nren, tot, emisiones.
      - De todos los servicios y desglosado por servicio
    - emisiones, desglose eléctrico y no eléctrico
    - Calcular ReduccionEPNR y ReduccionEmisiones por uso de renovables
  - Split XML output, generated from JSON results

## Wishlist

- use templates for output (plain, detailed, ...) depending on cli parameter
